{% extends "forum/base.html" %}


{% load staticfiles urlquery avatar %}


{% block javascript %}
    {{ block.super }}
    <script src="{% static "core/js/iso8601.js" %}" type="text/javascript"></script>
    <script src="{% static "core/js/jquery.js" %}" type="text/javascript"></script>
    <script src="{% static "forum/js/unseen.js" %}" type="text/javascript"></script>
    <script src="{% static "forum/js/viewcount.js" %}" type="text/javascript"></script>
    <script type="text/javascript" charset="utf-8">
        $(function () {
            $('.topic-unread').markUnseen({apiUrl: '{% url "forum:api-user-profile" %}'});
            $('.topic-view-counter').viewCount({apiUrl: '{% url "counter:get" %}'});
        });
    </script>
{% endblock %}


{% block forum_header %}
    {{ block.super }}
    | <a href="{% url "forum:mark-all-topics-read" %}">mark topics as read</a>
{% endblock %}


{% block forum_content %}
    <div class="box box-shadow text-center">
        <form action="{% url "forum:topics-list" %}" method="GET">
            <input type="search" name="q" value="{{ request.GET.q }}">
            {% for tag in tags %}
                <label>
                    <input type="checkbox" name="tag" value="{{ tag.label }}" {% if tag.checked %}checked{% endif %}> {{ tag.label }}
                </label>
            {% endfor %}
            <button class="btn" type="submit">Filter</button>
        </form>
    </div>

    <div class="box box-shadow content">
        {% for topic in topics %}
            <div class="topic row-fluid">
                <div class="span1">
                    {% gravatar_tag topic.author.avatar_url 24 %}
                    <span class="topic-unread" data-topic-id="{{ topic.id }}" data-topic-updated="{{ topic.updated.isoformat }}"></span>
                </div>
                <div class="span6">
                    <a href="{{ topic.get_absolute_url }}">{{ topic.subject }}</a>
                    <div class="author">by {{ topic.author.username }}</div>
                </div>
                <div class="span1">
                    <span>{{ topic.response_count }}</span>/<span class="topic-view-counter" data-topic-id="{{ topic.id }}"></span>
                </div>
                <div class="span3">
                    <small>{% for tag in topic.tags.all %}{{ tag }}{% if not forloop.last %}, {% endif %}{% endfor %}</small>
                </div>
                <div class="span1">
                    <small title="{{ topic.updated }}">{{ topic.updated|timesince }} ago</small>
                </div>
            </div>
        {% empty %}
            No topics
        {% endfor %}
    </div>

    <div class="box box-shadow text-center">
        {% if topics.has_previous %}
        <a href="?{% urlquery_set request page=topics.previous_page_number %}">previous</a>
        {% endif %}

        <span class="current">
            Page {{ topics.number }} of {{ topics.paginator.num_pages }}.
        </span>

        {% if topics.has_next %}
            <a href="?{% urlquery_set request page=topics.next_page_number %}">next</a>
        {% endif %}
    </div>
{% endblock %}
